  # Install partition management tools
  - name: Install partition management required packages
    apt:
      name: "{{ item }}"
      update_cache: yes
    tags: prt
    with_items:
      - expect
      - lvm2
      - parted

  # Prepare the scripts
  - name: Create the partitioning scripts
    template:
      src: "{{ item }}.j2"
      dest: "/root/{{ item }}"
      owner: root
      group: root
      mode: 750
    with_items:
      - resize-partition
      - create-partition
    tags: prt

  # Check that the partition does not exists
  - name: Check for /dev/vda2
    command: parted -s /dev/vda print 2
    register: vda2
    failed_when: vda2.rc is not defined
    changed_when: >
      vda2.stdout == "Error: Partition doesn't exist."
    tags: prt

  # Execute the partitioning script
  - name: Execute the partitioning script
    shell: "./{{ item }}"
    args:
      chdir: /root/
    when: vda2.rc != 0
    with_items:
      - resize-partition
      - create-partition
    tags: prt

  - name: Add LVM flag to /dev/vda2
    shell: parted -s /dev/vda set 2 lvm on
    when: vda2.rc != 0
    tags: prt

  - name: Create a PV/VG on /dev/vda2
    lvg:
      vg: vg0
      pvs: /dev/vda2
    tags: prt

  - name: Create data LV on vg0
    lvol:
      vg: vg0
      lv: data
      size: 100%FREE
    tags: prt
